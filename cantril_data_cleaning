#!/bin/bash

# Check if three file names are provided
if [ "$#" -ne 3 ]; then
    echo "Usage: $0 file1.tsv file2.tsv file3.tsv"
    exit 1
fi

file1=$1
file2=$2
file3=$3

echo "Checking files: $file1, $file2, $file3"
echo ""

# Process each file
for file in "$file1" "$file2" "$file3"; do

    echo "Processing file: $file"
    echo "----------------------------------------"

    # 获取文件的第一行
    first_line=$(head -n 1 "$file")

    # 检查第一行是否包含制表符
    if [[ "$first_line" =~ $'\t' ]]; then
        echo "File $file is already tab-separated."
        echo ""
    else
        # 使用 awk 将文件转换为制表符分隔格式
        awk 'BEGIN { FS="\t"; OFS="\t" } { print }' "$file" > "${file}.tmp"
        mv "${file}.tmp" "$file"
        echo "File $file has been converted to tab-separated format."
        echo ""
    fi

    # 获取标题行的单元格数量
    num_cells=$(head -n 1 "$file" | awk -F'\t' '{print NF}')

    # 检查文件中的每一行是否具有相同的单元格数量
    awk -F'\t' -v num_cells="$num_cells" '{
        if (NF != num_cells) {
            print "Line " NR " has a different number of cells."
        }
    }' "$file"


    column_number=$(awk -F '\t' '{ for (i=1; i<=NF; i++) if ($i == "Continent") {print i} }' "$file")

    result=$(awk -F'\t' '$2 != "" { print }' "$file")

    result=$(awk -F'\t' 'NR == 1 || ($3 >= 2011 && $3 <= 2021)' <<< "$result")

    if [ "$column_number" ]; then

        # awk -F '\t' -v col="$column_number" 'BEGIN {FS = "\t"; OFS = "\t"} {$col = ""; sub("\t\t","\t") } 1' <<< "$result" > "${file%.tsv}_processed.tsv"
        awk -F '\t' -v col="$column_number" 'BEGIN {FS = "\t"; OFS = "\t"} {$col = ""; sub("\t\t","\t") } 1' "$file" > tmpfile && mv tmpfile "$file"

    else

        echo "$result" > "$file"

    fi

    echo ""
done

# awk 'NR == 1 { print; next } NR == FNR {
#         key = ""
#         for (i = 1; i < NF - 1; i++)
#             key = key $i " "
#         array[key] = $0
#         next
#      }
#      {
#         key = ""
#         for (i = 1; i < NF - 1; i++)
#             key = key $i " "
#         if (key in array)
#             print array[key], $NF
#      }' $file1 $file2 > output.tsv


awk '
BEGIN {
    FS="\t"
    OFS="\t"
}

FNR==1 {
    next
}

{
    entity = $1
    code = $2
    year = $3
    if (FILENAME == "file1.tsv") {
        gdp_per_capita[entity,year] = $5
        population[entity,year] = $6
        cantril_score[entity,year] = $4
    } else if (FILENAME == "file2.tsv") {
        homicide_rate[entity,year] = $4
    } else if (FILENAME == "file3.tsv") {
        life_expectancy[entity,year] = $4
        cantril_score[entity,year] = $5
        population[entity,year] = $6
    }
}

END {
    for (key in gdp_per_capita) {
        split(key, keys, SUBSEP)
        entity = keys[1]
        year = keys[2]
        print entity, code[entity,year], year, gdp_per_capita[entity,year], population[entity,year], homicide_rate[entity,year], life_expectancy[entity,year], cantril_score[entity,year]
    }
}' $file1 $file2 $file3 > output.tsv

# awk 'NR==FNR {
#     a[$2,$3]=$0; 
#     next
# } 
# ($2,$3) in a {
#     print a[$2,$3] "\t" $0
# }' $file1 $file2 > output.tsv




